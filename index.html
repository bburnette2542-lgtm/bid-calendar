<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>JRE Production Board</title>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&family=IBM+Plex+Mono:wght@500;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family:'IBM Plex Sans','Segoe UI',system-ui,sans-serif; background:#f9fafb; color:#111827; }
    input,select,textarea,button { font-family:inherit; }
    ::-webkit-scrollbar { height:6px; width:6px; }
    ::-webkit-scrollbar-track { background:#f1f5f9; }
    ::-webkit-scrollbar-thumb { background:#cbd5e1; border-radius:3px; }
  </style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect, useMemo, useCallback, createContext, useContext } = React;

// ═══════════════════════════════════════════
// CONFIG
// ═══════════════════════════════════════════

const API = '';  // same origin

const DIVISIONS = {
  "Unit Masonry":     { color:"#b91c1c", bg:"#fef2f2" },
  "EIFS/Stucco":      { color:"#2563eb", bg:"#eff6ff" },
  "Siding & Trim":    { color:"#ca8a04", bg:"#fefce8" },
  "Joint Sealants":   { color:"#0d9488", bg:"#f0fdfa" },
  "Stone":            { color:"#78716c", bg:"#f5f5f4" },
  "Comm/Res Repairs": { color:"#c026d3", bg:"#fdf4ff" },
  "Package Project":  { color:"#ea580c", bg:"#fff7ed" },
};

const STATUS_CFG = {
  delayed:    { label:"Delayed",     color:"#dc2626", bg:"#fef2f2", border:"#fecaca", icon:"⚠",  order:0 },
  active:     { label:"Active",      color:"#16a34a", bg:"#f0fdf4", border:"#bbf7d0", icon:"●",  order:1 },
  completing: { label:"Completing",  color:"#2563eb", bg:"#eff6ff", border:"#bfdbfe", icon:"◉",  order:2 },
  pending:    { label:"Pending Mob", color:"#d97706", bg:"#fffbeb", border:"#fde68a", icon:"◌",  order:3 },
};

const JRE_MASONRY = ["K. Harper","M. Hennig","D. Johnson","J. Thomas"];

// ═══════════════════════════════════════════
// AUTH CONTEXT
// ═══════════════════════════════════════════

const AuthContext = createContext(null);

function useAuth() { return useContext(AuthContext); }

function AuthProvider({ children }) {
  const [user, setUser] = useState(null);
  const [token, setToken] = useState(localStorage.getItem('jre_token'));

  useEffect(() => {
    if (token) {
      fetch(API + '/api/me', { headers: { Authorization: 'Bearer ' + token } })
        .then(r => r.ok ? r.json() : Promise.reject())
        .then(u => setUser(u))
        .catch(() => { setToken(null); localStorage.removeItem('jre_token'); });
    }
  }, [token]);

  const login = async (username, password) => {
    const res = await fetch(API + '/api/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ username, password }),
    });
    if (!res.ok) throw new Error('Invalid credentials');
    const data = await res.json();
    localStorage.setItem('jre_token', data.token);
    setToken(data.token);
    setUser(data.user);
  };

  const logout = () => {
    localStorage.removeItem('jre_token');
    setToken(null);
    setUser(null);
  };

  const apiFetch = useCallback(async (url, opts = {}) => {
    const res = await fetch(API + url, {
      ...opts,
      headers: { ...opts.headers, Authorization: 'Bearer ' + token, 'Content-Type': 'application/json' },
    });
    if (!res.ok) {
      const err = await res.json().catch(() => ({}));
      throw new Error(err.error || 'Request failed');
    }
    return res.json();
  }, [token]);

  return (
    <AuthContext.Provider value={{ user, token, login, logout, apiFetch }}>
      {children}
    </AuthContext.Provider>
  );
}

// ═══════════════════════════════════════════
// HELPERS
// ═══════════════════════════════════════════

function parseDate(s) { const [y,m,d]=s.split("-").map(Number); return new Date(y,m-1,d); }
function diffDays(a,b) { return Math.round((b-a)/864e5); }
function fmtD(s) { return parseDate(s).toLocaleDateString("en-US",{month:"short",day:"numeric"}); }
function fmtDF(s) { return parseDate(s).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"}); }
function today() { return new Date(); }

// ═══════════════════════════════════════════
// LOGIN PAGE
// ═══════════════════════════════════════════

function LoginPage() {
  const { login } = useAuth();
  const [username, setUsername] = useState('');
  const [password, setPassword] = useState('');
  const [error, setError] = useState('');
  const [loading, setLoading] = useState(false);

  const handleSubmit = async () => {
    setError(''); setLoading(true);
    try { await login(username, password); }
    catch (e) { setError('Invalid username or password'); }
    setLoading(false);
  };

  return (
    <div style={{minHeight:"100vh",display:"flex",alignItems:"center",justifyContent:"center",background:"linear-gradient(135deg,#0f172a 0%,#1e293b 100%)"}}>
      <div style={{backgroundColor:"white",borderRadius:12,padding:40,width:360,boxShadow:"0 20px 60px rgba(0,0,0,0.3)"}}>
        <div style={{textAlign:"center",marginBottom:24}}>
          <div style={{fontSize:10,fontWeight:600,letterSpacing:"0.14em",color:"#94a3b8",textTransform:"uppercase",marginBottom:4}}>James River Exteriors</div>
          <h1 style={{fontSize:22,fontWeight:700,color:"#0f172a",letterSpacing:"-0.02em"}}>Production Board</h1>
        </div>
        <div style={{display:"flex",flexDirection:"column",gap:12}}>
          <div>
            <label style={{fontSize:11,fontWeight:600,color:"#6b7280",textTransform:"uppercase",letterSpacing:"0.05em"}}>Username</label>
            <input value={username} onChange={e=>setUsername(e.target.value)} onKeyDown={e=>e.key==='Enter'&&handleSubmit()}
              style={{width:"100%",padding:"10px 12px",borderRadius:6,border:"1px solid #d1d5db",fontSize:14,marginTop:4}} placeholder="e.g. gladwell" autoFocus />
          </div>
          <div>
            <label style={{fontSize:11,fontWeight:600,color:"#6b7280",textTransform:"uppercase",letterSpacing:"0.05em"}}>Password</label>
            <input type="password" value={password} onChange={e=>setPassword(e.target.value)} onKeyDown={e=>e.key==='Enter'&&handleSubmit()}
              style={{width:"100%",padding:"10px 12px",borderRadius:6,border:"1px solid #d1d5db",fontSize:14,marginTop:4}} />
          </div>
          {error && <div style={{fontSize:12,color:"#dc2626",textAlign:"center"}}>{error}</div>}
          <button onClick={handleSubmit} disabled={loading}
            style={{padding:"10px",borderRadius:6,border:"none",background:"#2563eb",color:"white",fontSize:14,fontWeight:600,cursor:"pointer",marginTop:4,opacity:loading?0.7:1}}>
            {loading ? "Signing in..." : "Sign In"}
          </button>
        </div>
      </div>
    </div>
  );
}

// ═══════════════════════════════════════════
// CREW TAG COMPONENT
// ═══════════════════════════════════════════

function CrewTag({ crew, laborType, compact }) {
  if (!crew) return <span style={{color:"#d97706",fontWeight:600}}>TBD</span>;
  const isSub = !JRE_MASONRY.includes(crew);
  const isThomas = crew === "J. Thomas";
  return (
    <span style={{display:"inline-flex",alignItems:"center",gap:4,flexWrap:"wrap"}}>
      <strong style={{fontSize:compact?12:undefined}}>{crew}</strong>
      {isThomas && laborType && (
        <span style={{fontSize:8,fontWeight:700,padding:"1px 5px",borderRadius:3,letterSpacing:"0.04em",
          backgroundColor:laborType==="JRE"?"#dcfce7":"#fce7f3",
          color:laborType==="JRE"?"#15803d":"#be185d",
        }}>{laborType==="JRE"?"IN-HOUSE":"MMA SUB"}</span>
      )}
      {isSub && !isThomas && (
        <span style={{fontSize:8,fontWeight:700,padding:"1px 4px",borderRadius:3,backgroundColor:"#fef3c7",color:"#92400e"}}>SUB</span>
      )}
    </span>
  );
}

// ═══════════════════════════════════════════
// EDIT JOB MODAL
// ═══════════════════════════════════════════

function EditModal({ job, refData, onSave, onDelete, onClose, isAdmin }) {
  const [form, setForm] = useState({
    name: job.name, location: job.location || '', division: job.division,
    crew: job.crew || '', labor_type: job.labor_type || '',
    pm: job.pm, status: job.status,
    start_date: job.start_date, end_date: job.end_date,
    progress: job.progress, notes: job.notes || '', next_milestone: job.next_milestone || '',
  });
  const [saving, setSaving] = useState(false);
  const [confirmDelete, setConfirmDelete] = useState(false);
  const [deleting, setDeleting] = useState(false);

  const crews = refData?.divisions?.[form.division] || [];
  const showLT = form.crew === "J. Thomas";

  const S = {
    inp: {width:"100%",padding:"6px 8px",borderRadius:5,border:"1px solid #d1d5db",fontSize:12},
    lbl: {fontSize:10,fontWeight:600,color:"#6b7280",textTransform:"uppercase",letterSpacing:"0.05em",marginBottom:2},
  };

  async function handleSave() {
    setSaving(true);
    try {
      await onSave({
        ...form,
        crew: form.crew || null,
        labor_type: form.crew === "J. Thomas" ? (form.labor_type || "JRE") : null,
        progress: parseInt(form.progress) || 0,
      });
      onClose();
    } catch (e) {
      alert(e.message);
    }
    setSaving(false);
  }

  return (
    <div style={{position:"fixed",inset:0,zIndex:1000,display:"flex",alignItems:"center",justifyContent:"center"}} onClick={onClose}>
      <div style={{position:"fixed",inset:0,backgroundColor:"rgba(0,0,0,0.5)"}} />
      <div onClick={e=>e.stopPropagation()} style={{
        position:"relative",backgroundColor:"white",borderRadius:12,padding:24,width:520,maxHeight:"90vh",overflowY:"auto",
        boxShadow:"0 20px 60px rgba(0,0,0,0.3)",
      }}>
        <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:16}}>
          <h2 style={{fontSize:18,fontWeight:700}}>Edit Job</h2>
          <button onClick={onClose} style={{background:"none",border:"none",fontSize:20,cursor:"pointer",color:"#9ca3af"}}>×</button>
        </div>

        <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:10}}>
          <div style={{gridColumn:"1/3"}}><div style={S.lbl}>Job Name</div><input value={form.name} onChange={e=>setForm({...form,name:e.target.value})} style={S.inp}/></div>
          <div><div style={S.lbl}>Location</div><input value={form.location} onChange={e=>setForm({...form,location:e.target.value})} style={S.inp}/></div>
          <div><div style={S.lbl}>Job Type</div>
            <select value={form.division} onChange={e=>setForm({...form,division:e.target.value,crew:"",labor_type:""})} style={S.inp}>
              {Object.keys(DIVISIONS).map(d=><option key={d}>{d}</option>)}
            </select>
          </div>
          <div><div style={S.lbl}>PM</div>
            <select value={form.pm} onChange={e=>setForm({...form,pm:e.target.value})} style={S.inp}>
              {(refData?.pms||[]).map(p=><option key={p}>{p}</option>)}
            </select>
          </div>
          <div><div style={S.lbl}>Crew</div>
            <select value={form.crew} onChange={e=>setForm({...form,crew:e.target.value,labor_type:e.target.value==="J. Thomas"?"JRE":""})} style={S.inp}>
              <option value="">Unassigned</option>
              {crews.map(c=><option key={c}>{c}</option>)}
            </select>
          </div>
          {showLT && (
            <div><div style={S.lbl}>Labor Type</div>
              <select value={form.labor_type} onChange={e=>setForm({...form,labor_type:e.target.value})} style={S.inp}>
                <option value="JRE">JRE (In-House)</option>
                <option value="MMA">MMA (Sub)</option>
              </select>
            </div>
          )}
          <div><div style={S.lbl}>Status</div>
            <select value={form.status} onChange={e=>setForm({...form,status:e.target.value})} style={S.inp}>
              {Object.entries(STATUS_CFG).map(([k,v])=><option key={k} value={k}>{v.label}</option>)}
            </select>
          </div>
          <div><div style={S.lbl}>Start Date</div><input type="date" value={form.start_date} onChange={e=>setForm({...form,start_date:e.target.value})} style={S.inp}/></div>
          <div><div style={S.lbl}>End Date</div><input type="date" value={form.end_date} onChange={e=>setForm({...form,end_date:e.target.value})} style={S.inp}/></div>
          <div><div style={S.lbl}>Progress %</div><input type="number" min="0" max="100" value={form.progress} onChange={e=>setForm({...form,progress:e.target.value})} style={S.inp}/></div>
          <div style={{gridColumn:"1/3"}}><div style={S.lbl}>Next Milestone</div><input value={form.next_milestone} onChange={e=>setForm({...form,next_milestone:e.target.value})} style={S.inp}/></div>
          <div style={{gridColumn:"1/3"}}><div style={S.lbl}>Notes</div><textarea value={form.notes} onChange={e=>setForm({...form,notes:e.target.value})} rows={3} style={{...S.inp,resize:"vertical"}}/></div>
        </div>

        <div style={{display:"flex",justifyContent:"space-between",gap:8,marginTop:16}}>
          <div>
            {isAdmin && !confirmDelete && (
              <button onClick={()=>setConfirmDelete(true)} style={{padding:"8px 14px",borderRadius:6,border:"1px solid #fecaca",background:"#fef2f2",color:"#dc2626",fontSize:12,fontWeight:600,cursor:"pointer"}}>
                Delete Job
              </button>
            )}
            {isAdmin && confirmDelete && (
              <div style={{display:"flex",alignItems:"center",gap:6}}>
                <span style={{fontSize:12,color:"#dc2626",fontWeight:600}}>Are you sure?</span>
                <button onClick={async()=>{setDeleting(true);try{await onDelete(job.id);onClose()}catch(e){alert(e.message)}setDeleting(false)}} disabled={deleting}
                  style={{padding:"6px 12px",borderRadius:5,border:"none",background:"#dc2626",color:"white",fontSize:11,fontWeight:600,cursor:"pointer",opacity:deleting?0.7:1}}>
                  {deleting?"Deleting...":"Yes, Delete"}
                </button>
                <button onClick={()=>setConfirmDelete(false)} style={{padding:"6px 12px",borderRadius:5,border:"1px solid #d1d5db",background:"white",fontSize:11,fontWeight:600,cursor:"pointer"}}>
                  No
                </button>
              </div>
            )}
          </div>
          <div style={{display:"flex",gap:8}}>
            <button onClick={onClose} style={{padding:"8px 16px",borderRadius:6,border:"1px solid #d1d5db",background:"white",fontSize:12,fontWeight:600,cursor:"pointer"}}>Cancel</button>
            <button onClick={handleSave} disabled={saving} style={{padding:"8px 20px",borderRadius:6,border:"none",background:"#2563eb",color:"white",fontSize:12,fontWeight:600,cursor:"pointer",opacity:saving?0.7:1}}>
              {saving?"Saving...":"Save Changes"}
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}

// ═══════════════════════════════════════════
// JOB CARD
// ═══════════════════════════════════════════

function JobCard({ job, expanded, onToggle, onEdit, canEdit }) {
  const d = DIVISIONS[job.division] || {color:"#6b7280",bg:"#f9fafb"};
  const now = today();
  const dl = job.status==="pending" ? diffDays(now,parseDate(job.start_date)) : diffDays(now,parseDate(job.end_date));
  const dur = diffDays(parseDate(job.start_date),parseDate(job.end_date));

  return (
    <div style={{
      backgroundColor:"white",borderRadius:10,overflow:"hidden",cursor:"pointer",
      transition:"all 0.2s",
      boxShadow:expanded?"0 4px 20px rgba(0,0,0,0.1)":"0 1px 3px rgba(0,0,0,0.06)",
      border:`1px solid ${expanded?d.color+"44":"#e5e7eb"}`,
    }}>
      <div style={{height:3,backgroundColor:d.color}}/>
      <div style={{padding:"12px 14px"}} onClick={onToggle}>
        <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:8}}>
          <span style={{fontSize:9,fontWeight:700,padding:"2px 7px",borderRadius:4,backgroundColor:d.bg,color:d.color,textTransform:"uppercase",letterSpacing:"0.06em"}}>{job.division}</span>
          <span style={{fontSize:10,fontWeight:700,fontFamily:"'IBM Plex Mono',monospace",color:dl<14&&job.status!=="pending"?"#dc2626":"#6b7280"}}>
            {job.status==="pending"?`${dl}d to mob`:`${dl}d left`}
          </span>
        </div>
        <div style={{fontSize:14,fontWeight:700,color:"#111827",lineHeight:1.3,marginBottom:2}}>{job.name}</div>
        <div style={{fontSize:11,color:"#9ca3af",marginBottom:8}}>{job.location}</div>
        {job.status!=="pending"&&(
          <div style={{marginBottom:8}}>
            <div style={{display:"flex",justifyContent:"space-between",marginBottom:3}}>
              <span style={{fontSize:10,color:"#6b7280"}}>{fmtD(job.start_date)} – {fmtD(job.end_date)}</span>
              <span style={{fontSize:11,fontWeight:700,color:d.color,fontFamily:"'IBM Plex Mono',monospace"}}>{job.progress}%</span>
            </div>
            <div style={{height:5,borderRadius:3,backgroundColor:"#f3f4f6",overflow:"hidden"}}>
              <div style={{height:"100%",borderRadius:3,width:`${job.progress}%`,backgroundColor:d.color,transition:"width 0.4s"}}/>
            </div>
          </div>
        )}
        <div style={{display:"flex",gap:10,marginBottom:6,fontSize:11,color:"#374151",flexWrap:"wrap"}}>
          <span><span style={{color:"#9ca3af"}}>Crew </span><CrewTag crew={job.crew} laborType={job.labor_type}/></span>
          <span><span style={{color:"#9ca3af"}}>PM </span><strong>{job.pm}</strong></span>
        </div>
        {job.next_milestone&&(
          <div style={{fontSize:11,padding:"5px 8px",borderRadius:5,backgroundColor:"#fafafa",border:"1px solid #f0f0f0",color:"#4b5563",display:"flex",alignItems:"center",gap:4}}>
            <span style={{color:"#d97706",fontSize:12}}>→</span>{job.next_milestone}
          </div>
        )}
        {expanded&&(
          <div style={{marginTop:10,paddingTop:10,borderTop:"1px solid #f3f4f6"}}>
            <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:6,fontSize:12,marginBottom:8}}>
              <div><span style={{color:"#9ca3af"}}>Start: </span><strong>{fmtDF(job.start_date)}</strong></div>
              <div><span style={{color:"#9ca3af"}}>End: </span><strong>{fmtDF(job.end_date)}</strong></div>
              <div><span style={{color:"#9ca3af"}}>Duration: </span><strong>{dur} days</strong></div>
              <div><span style={{color:"#9ca3af"}}>Updated: </span><strong>{job.updated_at ? new Date(job.updated_at).toLocaleDateString() : '—'}</strong></div>
            </div>
            {job.notes&&<div style={{fontSize:12,color:"#6b7280",fontStyle:"italic",marginBottom:8}}>{job.notes}</div>}
            {canEdit&&(
              <button onClick={e=>{e.stopPropagation();onEdit(job)}} style={{
                padding:"6px 14px",borderRadius:5,border:"1px solid #2563eb",background:"#eff6ff",color:"#2563eb",fontSize:11,fontWeight:600,cursor:"pointer",
              }}>Edit Job</button>
            )}
          </div>
        )}
      </div>
    </div>
  );
}

// ═══════════════════════════════════════════
// MAIN APP
// ═══════════════════════════════════════════

function Dashboard() {
  const { user, logout, apiFetch } = useAuth();
  const [jobs, setJobs] = useState([]);
  const [refData, setRefData] = useState(null);
  const [view, setView] = useState("board");
  const [fDiv, setFDiv] = useState("All");
  const [fPM, setFPM] = useState("All");
  const [fCrew, setFCrew] = useState("All");
  const [expId, setExpId] = useState(null);
  const [editJob, setEditJob] = useState(null);
  const [showAdd, setShowAdd] = useState(false);
  const [loading, setLoading] = useState(true);

  const emptyJob = {name:"",location:"",division:"Unit Masonry",crew:"",labor_type:"",pm:user?.display_name||"Gladwell",status:"pending",start_date:"",end_date:"",notes:"",next_milestone:""};
  const [nj, setNj] = useState(emptyJob);

  // Load data
  useEffect(() => {
    Promise.all([
      apiFetch('/api/jobs'),
      apiFetch('/api/reference'),
    ]).then(([j, r]) => {
      setJobs(j); setRefData(r); setLoading(false);
    }).catch(e => { console.error(e); setLoading(false); });
  }, [apiFetch]);

  // Refresh jobs
  const refreshJobs = useCallback(async () => {
    const j = await apiFetch('/api/jobs');
    setJobs(j);
  }, [apiFetch]);

  const now = today();
  const crewNames = useMemo(() => [...new Set(jobs.filter(j=>j.crew).map(j=>j.crew))].sort(), [jobs]);

  const filtered = useMemo(() => jobs.filter(j => {
    if (fDiv!=="All" && j.division!==fDiv) return false;
    if (fPM!=="All" && j.pm!==fPM) return false;
    if (fCrew!=="All" && j.crew!==fCrew) return false;
    return true;
  }), [jobs,fDiv,fPM,fCrew]);

  const byStatus = useMemo(() => {
    const g={}; Object.keys(STATUS_CFG).forEach(s=>g[s]=[]); filtered.forEach(j=>g[j.status]?.push(j)); return g;
  }, [filtered]);

  const byCrew = useMemo(() => {
    const g={}; filtered.forEach(j=>{const k=j.crew||"Unassigned";(g[k]=g[k]||[]).push(j)}); return g;
  }, [filtered]);

  const byDiv = useMemo(() => {
    const g={}; filtered.forEach(j=>(g[j.division]=g[j.division]||[]).push(j)); return g;
  }, [filtered]);

  function canEditJob(job) {
    return user?.role==='admin' || job.pm===user?.display_name;
  }

  // Add job
  async function handleAdd() {
    if (!nj.name||!nj.start_date||!nj.end_date) return;
    try {
      await apiFetch('/api/jobs', {
        method: 'POST',
        body: JSON.stringify({...nj, crew:nj.crew||null, labor_type:nj.crew==="J. Thomas"?(nj.labor_type||"JRE"):null, progress:0}),
      });
      setNj(emptyJob); setShowAdd(false); refreshJobs();
    } catch(e) { alert(e.message); }
  }

  // Save edit
  async function handleSaveEdit(data) {
    await apiFetch(`/api/jobs/${editJob.id}`, { method:'PUT', body:JSON.stringify(data) });
    refreshJobs();
  }

  // Delete job (admin only)
  async function handleDeleteJob(jobId) {
    await apiFetch(`/api/jobs/${jobId}`, { method:'DELETE' });
    refreshJobs();
  }

  const addCrews = refData?.divisions?.[nj.division] || [];
  const showLT = nj.crew === "J. Thomas";

  const S = {
    inp: {padding:"6px 8px",borderRadius:5,border:"1px solid #d1d5db",fontSize:12,width:"100%",boxSizing:"border-box"},
    lbl: {fontSize:10,fontWeight:600,color:"#6b7280",textTransform:"uppercase",letterSpacing:"0.05em",marginBottom:2},
    fsel: {padding:"5px 8px",borderRadius:5,border:"1px solid #d1d5db",fontSize:12,color:"#374151",cursor:"pointer"},
  };

  if (loading) {
    return <div style={{minHeight:"100vh",display:"flex",alignItems:"center",justifyContent:"center",fontSize:14,color:"#6b7280"}}>Loading...</div>;
  }

  return (
    <div style={{minHeight:"100vh"}}>
      {editJob && <EditModal job={editJob} refData={refData} onSave={handleSaveEdit} onDelete={handleDeleteJob} onClose={()=>setEditJob(null)} isAdmin={user?.role==='admin'} />}

      {/* HEADER */}
      <div style={{background:"linear-gradient(135deg,#0f172a 0%,#1e293b 100%)",padding:"16px 24px 14px",color:"white"}}>
        <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:10}}>
          <div>
            <div style={{fontSize:10,fontWeight:600,letterSpacing:"0.14em",color:"#64748b",textTransform:"uppercase",marginBottom:2}}>James River Exteriors</div>
            <h1 style={{fontSize:22,fontWeight:700,letterSpacing:"-0.02em"}}>Production Board</h1>
          </div>
          <div style={{display:"flex",alignItems:"center",gap:12}}>
            <span style={{fontSize:12,color:"#94a3b8"}}>
              {user?.display_name} {user?.role==='admin'&&<span style={{fontSize:9,padding:"1px 5px",borderRadius:3,backgroundColor:"rgba(255,255,255,0.15)",marginLeft:4}}>ADMIN</span>}
            </span>
            <button onClick={logout} style={{padding:"5px 12px",borderRadius:5,border:"1px solid rgba(255,255,255,0.2)",background:"transparent",color:"#94a3b8",fontSize:11,fontWeight:600,cursor:"pointer"}}>Sign Out</button>
          </div>
        </div>
        <div style={{display:"flex",gap:20,flexWrap:"wrap"}}>
          {Object.entries(STATUS_CFG).map(([k,c])=>(
            <div key={k} style={{display:"flex",alignItems:"center",gap:6}}>
              <div style={{width:8,height:8,borderRadius:"50%",backgroundColor:c.color}}/>
              <span style={{fontSize:11,color:"#94a3b8"}}>{c.label}</span>
              <span style={{fontSize:15,fontWeight:700,fontFamily:"'IBM Plex Mono',monospace"}}>{byStatus[k]?.length||0}</span>
            </div>
          ))}
        </div>
      </div>

      {/* CONTROLS */}
      <div style={{padding:"10px 24px",display:"flex",gap:8,flexWrap:"wrap",alignItems:"center",backgroundColor:"white",borderBottom:"1px solid #e5e7eb"}}>
        {["board","crew","type","list"].map(v=>(
          <button key={v} onClick={()=>setView(v)} style={{
            padding:"5px 12px",borderRadius:6,
            border:view===v?"1px solid #2563eb":"1px solid #d1d5db",
            background:view===v?"#eff6ff":"white",
            color:view===v?"#2563eb":"#374151",fontSize:12,fontWeight:600,cursor:"pointer",
          }}>{({board:"Status Board",crew:"By Crew",type:"By Type",list:"List"})[v]}</button>
        ))}
        <div style={{width:1,height:24,backgroundColor:"#e5e7eb",margin:"0 4px"}}/>
        <select value={fDiv} onChange={e=>{setFDiv(e.target.value);setFCrew("All")}} style={S.fsel}>
          <option value="All">All Types</option>
          {Object.keys(DIVISIONS).map(d=><option key={d}>{d}</option>)}
        </select>
        <select value={fPM} onChange={e=>setFPM(e.target.value)} style={S.fsel}>
          <option value="All">All PMs</option>
          {(refData?.pms||[]).map(p=><option key={p}>{p}</option>)}
        </select>
        <select value={fCrew} onChange={e=>setFCrew(e.target.value)} style={S.fsel}>
          <option value="All">All Crews</option>
          {crewNames.map(c=><option key={c}>{c}</option>)}
        </select>
        <div style={{flex:1}}/>
        <button onClick={()=>{refreshJobs()}} style={{padding:"6px 12px",borderRadius:6,border:"1px solid #d1d5db",background:"white",fontSize:12,fontWeight:600,cursor:"pointer",color:"#374151"}}>↻ Refresh</button>
        <button onClick={()=>setShowAdd(!showAdd)} style={{padding:"6px 14px",borderRadius:6,border:"none",background:showAdd?"#6b7280":"#2563eb",color:"white",fontSize:12,fontWeight:600,cursor:"pointer"}}>{showAdd?"Cancel":"+ Add Job"}</button>
      </div>

      {/* ADD FORM */}
      {showAdd&&(
        <div style={{padding:"14px 24px",backgroundColor:"#f0f9ff",borderBottom:"1px solid #bae6fd"}}>
          <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fill,minmax(145px,1fr))",gap:8,alignItems:"end"}}>
            <div><div style={S.lbl}>Job Name</div><input value={nj.name} onChange={e=>setNj({...nj,name:e.target.value})} style={S.inp} placeholder="Job name"/></div>
            <div><div style={S.lbl}>Location</div><input value={nj.location} onChange={e=>setNj({...nj,location:e.target.value})} style={S.inp} placeholder="City"/></div>
            <div><div style={S.lbl}>Job Type</div>
              <select value={nj.division} onChange={e=>setNj({...nj,division:e.target.value,crew:"",labor_type:""})} style={S.inp}>
                {Object.keys(DIVISIONS).map(d=><option key={d}>{d}</option>)}
              </select>
            </div>
            <div><div style={S.lbl}>PM</div>
              <select value={nj.pm} onChange={e=>setNj({...nj,pm:e.target.value})} style={S.inp}>
                {(refData?.pms||[]).map(p=><option key={p}>{p}</option>)}
              </select>
            </div>
            <div><div style={S.lbl}>Crew</div>
              <select value={nj.crew} onChange={e=>setNj({...nj,crew:e.target.value,labor_type:e.target.value==="J. Thomas"?"JRE":""})} style={S.inp}>
                <option value="">Unassigned</option>
                {addCrews.map(c=><option key={c}>{c}</option>)}
              </select>
            </div>
            {showLT&&(
              <div><div style={S.lbl}>Labor Type</div>
                <select value={nj.labor_type} onChange={e=>setNj({...nj,labor_type:e.target.value})} style={S.inp}>
                  <option value="JRE">JRE (In-House)</option>
                  <option value="MMA">MMA (Sub)</option>
                </select>
              </div>
            )}
            <div><div style={S.lbl}>Status</div>
              <select value={nj.status} onChange={e=>setNj({...nj,status:e.target.value})} style={S.inp}>
                {Object.entries(STATUS_CFG).map(([k,v])=><option key={k} value={k}>{v.label}</option>)}
              </select>
            </div>
            <div><div style={S.lbl}>Start</div><input type="date" value={nj.start_date} onChange={e=>setNj({...nj,start_date:e.target.value})} style={S.inp}/></div>
            <div><div style={S.lbl}>End</div><input type="date" value={nj.end_date} onChange={e=>setNj({...nj,end_date:e.target.value})} style={S.inp}/></div>
            <div><div style={S.lbl}>Next Milestone</div><input value={nj.next_milestone} onChange={e=>setNj({...nj,next_milestone:e.target.value})} style={S.inp} placeholder="e.g. Scaffold 3/1"/></div>
            <div style={{display:"flex",alignItems:"end"}}>
              <button onClick={handleAdd} style={{padding:"7px 20px",borderRadius:6,border:"none",background:"#16a34a",color:"white",fontSize:12,fontWeight:600,cursor:"pointer",width:"100%"}}>Add</button>
            </div>
          </div>
        </div>
      )}

      {/* ═══════ VIEWS ═══════ */}
      <div style={{padding:"16px 24px 32px"}}>

        {/* STATUS BOARD */}
        {view==="board"&&(
          <div style={{display:"grid",gridTemplateColumns:`repeat(${Object.keys(STATUS_CFG).length},1fr)`,gap:12,alignItems:"start"}}>
            {Object.entries(STATUS_CFG).map(([sk,cfg])=>(
              <div key={sk}>
                <div style={{display:"flex",alignItems:"center",gap:6,marginBottom:10,padding:"8px 10px",backgroundColor:cfg.bg,borderRadius:8,border:`1px solid ${cfg.border}`}}>
                  <span style={{fontSize:14}}>{cfg.icon}</span>
                  <span style={{fontSize:12,fontWeight:700,color:cfg.color}}>{cfg.label}</span>
                  <span style={{marginLeft:"auto",fontSize:13,fontWeight:700,fontFamily:"'IBM Plex Mono',monospace",color:cfg.color}}>{byStatus[sk]?.length||0}</span>
                </div>
                <div style={{display:"flex",flexDirection:"column",gap:8}}>
                  {(byStatus[sk]||[]).map(j=><JobCard key={j.id} job={j} expanded={expId===j.id} onToggle={()=>setExpId(expId===j.id?null:j.id)} canEdit={canEditJob(j)} onEdit={setEditJob}/>)}
                  {!(byStatus[sk]?.length)&&<div style={{padding:20,textAlign:"center",fontSize:12,color:"#9ca3af",fontStyle:"italic"}}>No jobs</div>}
                </div>
              </div>
            ))}
          </div>
        )}

        {/* BY CREW */}
        {view==="crew"&&(
          <div style={{display:"flex",flexDirection:"column",gap:16}}>
            {Object.entries(byCrew).sort(([a],[b])=>a==="Unassigned"?1:b==="Unassigned"?-1:a.localeCompare(b)).map(([cn,cj])=>{
              const isThomas=cn==="J. Thomas";
              const jre=isThomas?cj.filter(j=>j.labor_type==="JRE").length:0;
              const mma=isThomas?cj.filter(j=>j.labor_type==="MMA").length:0;
              const act=cj.filter(j=>j.status==="active"||j.status==="delayed").length;
              return(
                <div key={cn}>
                  <div style={{display:"flex",alignItems:"center",gap:8,marginBottom:8,padding:"8px 12px",backgroundColor:cn==="Unassigned"?"#fef3c7":"#f0fdf4",borderRadius:8,border:`1px solid ${cn==="Unassigned"?"#fde68a":"#bbf7d0"}`,flexWrap:"wrap"}}>
                    <span style={{fontSize:13,fontWeight:700,color:cn==="Unassigned"?"#92400e":"#166534"}}>{cn}</span>
                    <span style={{fontSize:11,color:"#6b7280"}}>{cj.length} job{cj.length!==1?"s":""}</span>
                    {isThomas&&<>{jre>0&&<span style={{fontSize:10,fontWeight:600,padding:"2px 6px",borderRadius:4,backgroundColor:"#dcfce7",color:"#15803d"}}>{jre} In-House</span>}{mma>0&&<span style={{fontSize:10,fontWeight:600,padding:"2px 6px",borderRadius:4,backgroundColor:"#fce7f3",color:"#be185d"}}>{mma} MMA Sub</span>}</>}
                    {!isThomas&&cn!=="Unassigned"&&act>1&&<span style={{fontSize:10,fontWeight:600,padding:"2px 6px",borderRadius:4,backgroundColor:"#fef2f2",color:"#dc2626"}}>{act} active</span>}
                  </div>
                  <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fill,minmax(280px,1fr))",gap:8}}>
                    {cj.map(j=><JobCard key={j.id} job={j} expanded={expId===j.id} onToggle={()=>setExpId(expId===j.id?null:j.id)} canEdit={canEditJob(j)} onEdit={setEditJob}/>)}
                  </div>
                </div>
              );
            })}
          </div>
        )}

        {/* BY TYPE */}
        {view==="type"&&(
          <div style={{display:"flex",flexDirection:"column",gap:16}}>
            {Object.entries(DIVISIONS).filter(([k])=>byDiv[k]?.length).map(([dn,dc])=>(
              <div key={dn}>
                <div style={{display:"flex",alignItems:"center",gap:8,marginBottom:8,padding:"8px 12px",backgroundColor:dc.bg,borderRadius:8,borderLeft:`4px solid ${dc.color}`,border:`1px solid ${dc.color}22`,flexWrap:"wrap"}}>
                  <span style={{fontSize:13,fontWeight:700,color:dc.color}}>{dn}</span>
                  <span style={{fontSize:11,color:"#6b7280"}}>{byDiv[dn].length} job{byDiv[dn].length!==1?"s":""}</span>
                  <span style={{fontSize:10,color:"#9ca3af",marginLeft:4}}>Crews: {(refData?.divisions?.[dn]||[]).join(", ")}</span>
                </div>
                <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fill,minmax(280px,1fr))",gap:8}}>
                  {byDiv[dn].map(j=><JobCard key={j.id} job={j} expanded={expId===j.id} onToggle={()=>setExpId(expId===j.id?null:j.id)} canEdit={canEditJob(j)} onEdit={setEditJob}/>)}
                </div>
              </div>
            ))}
          </div>
        )}

        {/* LIST */}
        {view==="list"&&(
          <div style={{backgroundColor:"white",borderRadius:10,overflow:"hidden",border:"1px solid #e5e7eb"}}>
            <div style={{display:"grid",gridTemplateColumns:"2.2fr 1fr 1.2fr 0.7fr 0.7fr 0.5fr 1.5fr",padding:"10px 14px",backgroundColor:"#f9fafb",borderBottom:"1px solid #e5e7eb",fontSize:10,fontWeight:700,color:"#6b7280",textTransform:"uppercase",letterSpacing:"0.06em"}}>
              <div>Job</div><div>Type</div><div>Crew</div><div>PM</div><div>Status</div><div>%</div><div>Next Milestone</div>
            </div>
            {filtered.sort((a,b)=>(STATUS_CFG[a.status]?.order||0)-(STATUS_CFG[b.status]?.order||0)).map((job,i)=>{
              const d=DIVISIONS[job.division]||{color:"#6b7280",bg:"#f9fafb"};
              const sc=STATUS_CFG[job.status]||{color:"#6b7280",label:"?"};
              return(
                <div key={job.id} onClick={()=>{setExpId(expId===job.id?null:job.id);if(canEditJob(job))setEditJob(job)}} style={{
                  display:"grid",gridTemplateColumns:"2.2fr 1fr 1.2fr 0.7fr 0.7fr 0.5fr 1.5fr",
                  padding:"10px 14px",borderBottom:"1px solid #f3f4f6",cursor:"pointer",alignItems:"center",
                  backgroundColor:i%2===0?"white":"#fafbfc",transition:"background 0.15s",
                }}
                  onMouseEnter={e=>e.currentTarget.style.backgroundColor="#f5f7ff"}
                  onMouseLeave={e=>e.currentTarget.style.backgroundColor=i%2===0?"white":"#fafbfc"}>
                  <div>
                    <div style={{fontSize:13,fontWeight:600}}>{job.name}</div>
                    <div style={{fontSize:11,color:"#9ca3af"}}>{job.location} · {fmtD(job.start_date)} – {fmtD(job.end_date)}</div>
                  </div>
                  <div><span style={{fontSize:9,fontWeight:700,padding:"2px 6px",borderRadius:3,backgroundColor:d.bg,color:d.color,textTransform:"uppercase"}}>{job.division}</span></div>
                  <div style={{fontSize:12}}><CrewTag crew={job.crew} laborType={job.labor_type} compact/></div>
                  <div style={{fontSize:12}}>{job.pm}</div>
                  <div style={{display:"flex",alignItems:"center",gap:4}}>
                    <span style={{width:7,height:7,borderRadius:"50%",backgroundColor:sc.color}}/>
                    <span style={{fontSize:11,fontWeight:600,color:sc.color}}>{sc.label.split(" ")[0]}</span>
                  </div>
                  <div style={{fontSize:12,fontWeight:700,fontFamily:"'IBM Plex Mono',monospace",color:d.color}}>{job.status==="pending"?"—":`${job.progress}%`}</div>
                  <div style={{fontSize:11,color:"#6b7280"}}>{job.next_milestone||"—"}</div>
                </div>
              );
            })}
          </div>
        )}
      </div>

      {/* LEGEND */}
      <div style={{padding:"0 24px 24px",display:"flex",gap:10,flexWrap:"wrap"}}>
        {Object.entries(DIVISIONS).map(([k,d])=>(
          <div key={k} style={{display:"flex",alignItems:"center",gap:4}}>
            <div style={{width:10,height:10,borderRadius:2,backgroundColor:d.bg,borderLeft:`3px solid ${d.color}`}}/>
            <span style={{fontSize:10,color:"#6b7280"}}>{k}</span>
          </div>
        ))}
      </div>
    </div>
  );
}

// ═══════════════════════════════════════════
// ROOT
// ═══════════════════════════════════════════

function App() {
  return (
    <AuthProvider>
      <AuthSwitch />
    </AuthProvider>
  );
}

function AuthSwitch() {
  const { user } = useAuth();
  return user ? <Dashboard /> : <LoginPage />;
}

ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
</body>
</html>
